generator client {
  provider     = "prisma-client"
  output       = "../generated"
  moduleFormat = "esm"
  runtime      = "bun"
}

datasource db {
  provider = "postgresql"
}

enum JobStatus {
  CREATED
  FUNDED
  WAITING_FUNDING
  IN_PROGRESS
  COMPLETED
  DISPUTED
  RESOLVED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  COMPLETED
}

model Job {
  id String @id @default(uuid())

  // UX only
  title       String
  description String

  // On-chain identifiers
  // onChainId BigInt?   @unique
  onChainId Int?      @unique
  jobHash   String // bytes32
  status    JobStatus @default(CREATED)

  // Parties (wallets, NOT users for MVP)
  clientWallet     String
  freelancerWallet String?
  arbiter          String

  // Payment
  tokenAddress String? // null = ETH
  totalAmount  Decimal @db.Decimal(38, 0) // store wei safely

  // Relations
  milestones      Milestone[]
  messages        Message[]
  reviews         Review[]
  jobApplications JobApplication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Milestone {
  id String @id @default(uuid())

  jobId           String
  onChainIndex    Int
  amount          Decimal         @db.Decimal(38, 0)
  descriptionHash String
  submissionHash  String?
  status          MilestoneStatus @default(PENDING)

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([jobId, onChainIndex])
  @@index([jobId])
}

model Review {
  id String @id @default(uuid())

  jobId String
  job   Job    @relation(fields: [jobId], references: [id])

  reviewerWallet String
  revieweeWallet String

  rating  Int
  comment String?

  createdAt DateTime @default(now())
}

model Message {
  id      String @id @default(uuid())
  jobId   String
  sender  String // wallet address
  content String

  job Job @relation(fields: [jobId], references: [id])

  createdAt DateTime @default(now())
}

model JobApplication {
  id String @id @default(uuid())

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  freelancerWallet String
  coverLetter      String?
  status           ApplicationStatus @default(PENDING)

  createdAt DateTime @default(now())

  @@unique([jobId, freelancerWallet])
}
