generator client {
  provider     = "prisma-client"
  output       = "../generated"
  moduleFormat = "esm"
  runtime      = "bun"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CLIENT
  FREELANCER
  BOTH
}

enum JobStatus {
  CREATED
  OPEN
  FUNDED
  IN_PROGRESS
  COMPLETED
  DISPUTED
  RESOLVED
  CANCELLED
}

enum MilestoneStatus {
  PENDING
  SUBMITTED
  APPROVED
  DISPUTED
}

model Job {
  id           String   @id @default(uuid())
  title        String
  description  String
  requirements String?
  budget       Decimal? @db.Decimal(18, 2)

  // On-chain linkage
  onChainId       BigInt?  @unique
  jobHash         String? // bytes32 from createJob
  milestoneHashes String[] // array of milestone description hashes (in order)
  tokenAddress    String? // "0x000...000" for ETH
  isNativeEth     Boolean  @default(true)
  arbiter         String? // arbiter wallet address

  status JobStatus @default(CREATED)

  // Relations
  clientId     String
  client       User    @relation("ClientJobs", fields: [clientId], references: [id])
  freelancerId String?
  freelancer   User?   @relation("FreelancerJobs", fields: [freelancerId], references: [id])

  milestones Milestone[]
  reviews    Review[]
  messages   Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Milestone {
  id          String          @id @default(uuid())
  title       String
  description String?
  amount      Decimal         @db.Decimal(18, 2)
  status      MilestoneStatus @default(PENDING)

  // On-chain sync
  onChainIndex   Int // matches contract milestone array index
  submissionHash String? // bytes32 from submitMilestone

  // Proof of work
  submissionProof String? // IPFS hash or link

  // Relations
  jobId String
  job   Job    @relation(fields: [jobId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id      String  @id @default(uuid())
  rating  Int // 1-5
  comment String?

  jobId      String
  job        Job    @relation(fields: [jobId], references: [id])
  reviewerId String
  reviewer   User   @relation("Reviewer", fields: [reviewerId], references: [id])
  revieweeId String
  reviewee   User   @relation("Reviewee", fields: [revieweeId], references: [id])

  createdAt DateTime @default(now())
}

model Message {
  id      String @id @default(uuid())
  content String

  jobId      String?
  job        Job?    @relation(fields: [jobId], references: [id])
  senderId   String
  sender     User    @relation("Sender", fields: [senderId], references: [id])
  receiverId String
  receiver   User    @relation("Receiver", fields: [receiverId], references: [id])

  createdAt DateTime @default(now())
}
